<div class="payment-container">
  <div *ngIf="isPaymentSuccessful" class="success-container">
    <div class="success-card">
      <div class="success-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <h2>Payment Successful!</h2>
      <p>
        Your booking for {{ reservation.property.name }} has been confirmed.
      </p>
      <p>Confirmation #{{ reservation.id }}</p>
      <p>Check your email for booking details.</p>
      <button routerLink="/trips" class="primary-btn">View My Trips</button>
      <button routerLink="/" class="secondary-btn">Back to Home</button>
    </div>
  </div>

  <div *ngIf="!isPaymentSuccessful" class="payment-page">
    <div class="payment-left">
      <h2>Confirm and pay</h2>
      <div class="trip-summary">
        <h3>Your trip</h3>
        <div class="trip-detail">
          <span class="detail-label">Dates</span>
          <span
            >{{ formatDate(reservation.dates.checkIn) }} -
            {{ formatDate(reservation.dates.checkOut) }}</span
          >
        </div>
        <div class="trip-detail">
          <span class="detail-label">Guests</span>
          <span>
            {{ reservation.guests.adults }} adult{{
              reservation.guests.adults > 1 ? "s" : ""
            }}
            <ng-container *ngIf="reservation.guests.children > 0">
              , {{ reservation.guests.children }} child{{
                reservation.guests.children > 1 ? "ren" : ""
              }}
            </ng-container>
            <ng-container *ngIf="reservation.guests.infants > 0">
              , {{ reservation.guests.infants }} infant{{
                reservation.guests.infants > 1 ? "s" : ""
              }}
            </ng-container>
          </span>
        </div>
      </div>

      <div class="payment-section">
        <h3>Pay with</h3>
        <form [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
          <div class="payment-methods">
            <div *ngFor="let method of paymentMethods" class="payment-method">
              <input
                type="radio"
                [id]="method.id"
                formControlName="paymentMethod"
                [value]="method.id"
              />
              <label [for]="method.id">
                <i class="material-icons">{{ method.icon }}</i>
                {{ method.name }}
              </label>
            </div>
          </div>

          <div
            *ngIf="paymentForm.get('paymentMethod')?.value === 'card'"
            class="card-details"
          >
            <div class="form-group">
              <label for="cardName">Name on card</label>
              <input
                type="text"
                id="cardName"
                formControlName="cardName"
                placeholder="Cardholder name"
              />
              <div
                *ngIf="
                  paymentForm.get('cardName')?.touched &&
                  paymentForm.get('cardName')?.invalid
                "
                class="error-msg"
              >
                Please enter the name on card
              </div>
            </div>

            <div class="form-group">
              <label for="cardNumber">Card number</label>
              <input
                type="text"
                id="cardNumber"
                formControlName="cardNumber"
                placeholder="1234 5678 9012 3456"
              />
              <div
                *ngIf="
                  paymentForm.get('cardNumber')?.touched &&
                  paymentForm.get('cardNumber')?.invalid
                "
                class="error-msg"
              >
                Please enter a valid card number
              </div>
            </div>

            <div class="card-row">
              <div class="form-group">
                <label for="expiryDate">Expiry date</label>
                <input
                  type="text"
                  id="expiryDate"
                  formControlName="expiryDate"
                  placeholder="MM/YY"
                />
                <div
                  *ngIf="
                    paymentForm.get('expiryDate')?.touched &&
                    paymentForm.get('expiryDate')?.invalid
                  "
                  class="error-msg"
                >
                  Invalid format
                </div>
              </div>

              <div class="form-group">
                <label for="cvv">CVV</label>
                <input
                  type="text"
                  id="cvv"
                  formControlName="cvv"
                  placeholder="123"
                />
                <div
                  *ngIf="
                    paymentForm.get('cvv')?.touched &&
                    paymentForm.get('cvv')?.invalid
                  "
                  class="error-msg"
                >
                  Invalid CVV
                </div>
              </div>
            </div>
          </div>

          <div formGroupName="billingAddress" class="billing-address">
            <h3>Billing address</h3>

            <div class="form-group">
              <label for="country">Country/Region</label>
              <select id="country" formControlName="country">
                <option value="United States">United States</option>
                <option value="Canada">Canada</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="Cairo">Cairo</option>
              </select>
            </div>

            <div class="form-group">
              <label for="address">Address</label>
              <input
                type="text"
                id="address"
                formControlName="address"
                placeholder="Street address"
              />
              <div
                *ngIf="
                  paymentForm.get('billingAddress.address')?.touched &&
                  paymentForm.get('billingAddress.address')?.invalid
                "
                class="error-msg"
              >
                Address is required
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" formControlName="city" />
                <div
                  *ngIf="
                    paymentForm.get('billingAddress.city')?.touched &&
                    paymentForm.get('billingAddress.city')?.invalid
                  "
                  class="error-msg"
                >
                  City is required
                </div>
              </div>

              <div class="form-group">
                <label for="state">State</label>
                <input type="text" id="state" formControlName="state" />
                <div
                  *ngIf="
                    paymentForm.get('billingAddress.state')?.touched &&
                    paymentForm.get('billingAddress.state')?.invalid
                  "
                  class="error-msg"
                >
                  State is required
                </div>
              </div>

              <div class="form-group">
                <label for="zipCode">ZIP Code</label>
                <input type="text" id="zipCode" formControlName="zipCode" />
                <div
                  *ngIf="
                    paymentForm.get('billingAddress.zipCode')?.touched &&
                    paymentForm.get('billingAddress.zipCode')?.invalid
                  "
                  class="error-msg"
                >
                  Valid ZIP code is required
                </div>
              </div>
            </div>
          </div>

          <div class="terms-section">
            <p>
              By selecting the button below, I agree to the Host's House Rules,
              Cancellation Policy, and the Airbnb Clone Terms of Service and
              Privacy Policy.
            </p>
          </div>

          <button type="submit" class="payment-btn" [disabled]="isProcessing">
            <span *ngIf="!isProcessing">Confirm and pay</span>
            <span *ngIf="isProcessing">Processing...</span>
          </button>
        </form>
      </div>
    </div>

    <div class="payment-right">
      <div class="reservation-card">
        <div class="property-preview">
          <img [src]="reservation.property.image" alt="Property image" />
          <div class="property-details">
            <h4>{{ reservation.property.name }}</h4>
            <p>{{ reservation.property.location }}</p>
            <div class="host-details">
              <span>Hosted by {{ reservation.host.name }}</span>
              <div class="host-rating">
                <i class="material-icons">star</i>
                <span>{{ reservation.host.rating }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="price-details">
          <h4>Price details</h4>
          <div class="price-row">
            <span
              >${{ reservation.price.perNight }} x
              {{ getTotalNights() }} nights</span
            >
            <span>${{ reservation.price.perNight * getTotalNights() }}</span>
          </div>
          <div class="price-row">
            <span>Cleaning fee</span>
            <span>${{ reservation.price.cleaningFee }}</span>
          </div>
          <div class="price-row">
            <span>Service fee</span>
            <span>${{ reservation.price.serviceFee }}</span>
          </div>
          <div class="price-row total">
            <span>Total (USD)</span>
            <span>${{ reservation.price.total }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
